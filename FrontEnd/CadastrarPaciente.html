<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Pacientes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding-top: 70px; }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow">
  <div class="container">
    <a class="navbar-brand" href="#">Sistema de Pacientes</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Início</a></li>
        <li class="nav-item"><a class="nav-link" href="EfetuarConsultas.html">Efetuar Consultas</a></li>
        <li class="nav-item"><a class="nav-link" href="EfetuarInternacoes.html">Efetuar Internações</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-5">
  <h2 class="text-center mb-4">Cadastro de Pacientes</h2>
  <form id="formPaciente">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="paciId" class="form-label">ID</label>
        <input type="number" id="paciId" class="form-control">
      </div>
      <div class="col-md-6"><label class="form-label">Nome</label><input type="text" id="paciNome" class="form-control" required></div>
      <div class="col-md-6"><label class="form-label">CPF</label><input type="text" id="paciCPF" class="form-control" required></div>
      <div class="col-md-6"><label class="form-label">Convênio</label><input type="text" id="paciConvenio" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Data de Internação</label><input type="date" id="paciData_Internacao" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Data de Alta</label><input type="date" id="paciData_Alta" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Endereço</label><input type="text" id="paciEndereco" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">RG</label><input type="text" id="paciRg" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Telefone</label><input type="tel" id="paciTelefone" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Data de Nascimento</label><input type="date" id="paciData_Nascimento" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">CEP</label><input type="text" id="paciCep" class="form-control"></div>
      <div class="col-md-6 d-flex align-items-end">
        <button type="button" id="btnBuscarCPF" class="btn btn-secondary w-100">Buscar por CPF</button>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-4 justify-content-evenly">
      <button type="button" id="btnCadastrar" class="btn btn-success">Cadastrar</button>
      <button type="button" id="btnAlterar" class="btn btn-warning text-white">Alterar</button>
      <button type="button" id="btnExcluir" class="btn btn-danger">Excluir</button>
      <button type="reset" class="btn btn-secondary">Limpar</button>
      <button type="button" id="btnBuscar" class="btn btn-primary">Buscar por ID</button>
      <button type="button" id="btnAtualizar" class="btn btn-dark">Atualizar</button>
      <button type="button" class="btn btn-info text-white" onclick="listarPacientes()">Listar Pacientes</button>
    </div>
  </form>
</div>

<div class="container mt-5">
  <div class="table-responsive">
    <table class="table table-bordered" id="tabelaPacientes" style="display: none;">
      <thead class="table-primary text-center">
        <tr>
          <th>ID</th><th>Nome</th><th>CPF</th><th>Convênio</th><th>Internação</th><th>Alta</th><th>Endereço</th><th>RG</th><th>Telefone</th><th>Nascimento</th><th>CEP</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
function aplicarMascara(input, mascara) {
  input.addEventListener("input", () => input.value = mascara(input.value));
}
const removerMascara = str => str.replace(/\D/g, '');

function mascaraCPF(v) {
  return v.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2")
          .replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function mascaraTelefone(v) {
  v = v.replace(/\D/g,"");
  return v.length > 10 ? v.replace(/(\d{2})(\d{5})(\d{4})/,"($1) $2-$3")
                       : v.replace(/(\d{2})(\d{4})(\d{4})/,"($1) $2-$3");
}
function mascaraRG(v) {
  return v.replace(/\D/g,"").replace(/(\d{2})(\d)/,"$1.$2")
          .replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1})$/,"$1-$2");
}
function mascaraCEP(v) {
  return v.replace(/\D/g,"").replace(/(\d{5})(\d)/,"$1-$2");
}

aplicarMascara(document.getElementById("paciCPF"), mascaraCPF);
aplicarMascara(document.getElementById("paciTelefone"), mascaraTelefone);
aplicarMascara(document.getElementById("paciRg"), mascaraRG);
aplicarMascara(document.getElementById("paciCep"), mascaraCEP);

document.getElementById("paciCep").addEventListener("blur", function() {
  const cep = this.value.replace(/\D/g, "");
  if (cep.length !== 8) return;
  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(res => res.json())
    .then(data => {
      if (!data.erro) {
        document.getElementById("paciEndereco").value = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
      }
    });
});

document.getElementById("btnAtualizar").addEventListener("click", () => location.reload());

function getPacienteForm() {
  return {
    paciId: document.getElementById("paciId").value || null,
    paciNome: document.getElementById("paciNome").value.trim(),
    paciCPF: removerMascara(document.getElementById("paciCPF").value),
    paciConvenio: document.getElementById("paciConvenio").value.trim(),
    paciDataInternacao: document.getElementById("paciData_Internacao").value,
    paciDataAlta: document.getElementById("paciData_Alta").value,
    paciEndereco: document.getElementById("paciEndereco").value,
    paciRg: document.getElementById("paciRg").value,
    paciTelefone: document.getElementById("paciTelefone").value,
    paciDataNascimento: document.getElementById("paciData_Nascimento").value,
    paciCep: document.getElementById("paciCep").value
  };
}

document.getElementById("btnCadastrar").addEventListener("click", () => {
  const paciente = getPacienteForm();
  fetch("http://localhost:8080/api/pacientes/cadastrar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(paciente)
  })
    .then(res => {
      if (!res.ok) throw new Error();
      alert("Paciente cadastrado!");
      document.getElementById("formPaciente").reset();
      listarPacientes();
    })
    .catch(() => alert("Erro ao cadastrar"));
});

document.getElementById("btnAlterar").addEventListener("click", () => {
  const paciente = getPacienteForm();
  if (!paciente.paciId) return alert("Informe o ID");
  fetch("http://localhost:8080/api/pacientes/alterar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(paciente)
  })
    .then(res => res.json())
    .then(data => alert(data.success ? "Alterado!" : "Erro ao alterar"));
});

document.getElementById("btnExcluir").addEventListener("click", () => {
  const id = document.getElementById("paciId").value;
  if (!id) return alert("Informe o ID");
  if (!confirm("Confirma exclusão?")) return;
  fetch(`http://localhost:8080/api/pacientes/excluir/${id}`, { method: "DELETE" })
    .then(res => {
      if (!res.ok) throw new Error();
      alert("Excluído!");
      document.getElementById("formPaciente").reset();
    })
    .catch(() => alert("Erro ao excluir"));
});

document.getElementById("btnBuscar").addEventListener("click", () => {
  const id = document.getElementById("paciId").value;
  if (!id) return alert("Informe o ID");
  fetch(`http://localhost:8080/api/pacientes/buscar/${id}`)
    .then(res => res.json())
    .then(p => preencherCampos(p))
    .catch(() => alert("Paciente não encontrado"));
});

document.getElementById("btnBuscarCPF").addEventListener("click", () => {
  const cpf = document.getElementById("paciCPF").value;
  fetch(`http://localhost:8080/api/pacientes/buscarCPF/${encodeURIComponent(cpf)}`)
    .then(res => res.json())
    .then(p => preencherCampos(p))
    .catch(() => alert("CPF não encontrado"));
});

function preencherCampos(p) {
  document.getElementById("paciId").value = p.paciId || "";
  document.getElementById("paciNome").value = p.paciNome || "";
  document.getElementById("paciCPF").value = p.paciCPF || "";
  document.getElementById("paciConvenio").value = p.paciConvenio || "";
  document.getElementById("paciData_Internacao").value = p.paciDataInternacao || "";
  document.getElementById("paciData_Alta").value = p.paciDataAlta || "";
  document.getElementById("paciEndereco").value = p.paciEndereco || "";
  document.getElementById("paciRg").value = p.paciRg || "";
  document.getElementById("paciTelefone").value = p.paciTelefone || "";
  document.getElementById("paciData_Nascimento").value = p.paciDataNascimento || "";
  document.getElementById("paciCep").value = p.paciCep || "";
}

function listarPacientes() {
  fetch("http://localhost:8080/api/pacientes/listar")
    .then(res => res.json())
    .then(data => {
      const tabela = document.getElementById("tabelaPacientes");
      const tbody = tabela.querySelector("tbody");
      tbody.innerHTML = "";
      if (!data.length) {
        tabela.style.display = "none";
        return alert("Nenhum paciente");
      }
      data.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.paciId}</td><td>${p.paciNome}</td><td>${p.paciCPF}</td><td>${p.paciConvenio}</td>
          <td>${p.paciDataInternacao || ""}</td><td>${p.paciDataAlta || ""}</td>
          <td>${p.paciEndereco}</td><td>${p.paciRg}</td><td>${p.paciTelefone}</td>
          <td>${p.paciDataNascimento || ""}</td><td>${p.paciCep}</td>`;
        tbody.appendChild(tr);
      });
      tabela.style.display = "table";
    });
}
</script>
</body>
</html>
