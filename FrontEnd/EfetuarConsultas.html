<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Efetuar Consulta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/imask"></script>
  <style>
    body { background-color: #f8f9fa; padding: 30px; }
    .container {
      max-width: 850px;
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .form-title { text-align: center; margin-bottom: 25px; }
    #mensagem { margin-top: 12px; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="form-title">Efetuar Consulta</h3>
  <form id="consultaForm">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nome do Médico</label>
        <input type="text" name="medNome" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Especialidade</label>
        <input type="text" name="medEspecialidade" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Data da Consulta</label>
        <input type="date" name="conData" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Horário (HH:mm)</label>
        <input type="time" name="horarioConsulta" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Nome do Paciente</label>
        <input type="text" name="paciNome" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">CPF do Paciente</label>
        <div class="input-group">
          <input type="text" name="paciCPF" id="paciCPF" class="form-control" required>
          <button type="button" class="btn btn-outline-secondary" onclick="buscarPaciente()">Buscar</button>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Convênio</label>
        <input type="text" name="paciConvenio" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Data da Última Consulta</label>
        <input type="date" name="dataUltimaConsulta" class="form-control" required>
      </div>
      <div class="col-md-12">
        <label class="form-label">Tipo de Consulta</label>
        <input type="text" name="conTipo" maxlength="50" class="form-control" required>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-4 w-100">Enviar</button>
    <div id="mensagem"></div>
  </form>

  <hr class="my-4">
  <h5>Consultas Registradas</h5>
  <table class="table table-bordered" id="tabelaConsultas">
    <thead class="table-light">
      <tr>
        <th>Médico</th><th>Especialidade</th><th>Paciente</th>
        <th>CPF</th><th>Convênio</th><th>Data</th><th>Hora</th><th>Tipo</th><th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
IMask(document.getElementById("paciCPF"), { mask: "000.000.000-00" });

function buscarPaciente() {
  const cpf = document.getElementById("paciCPF").value;
  if (!cpf) {
    alert("Informe um CPF para buscar.");
    return;
  }

  fetch(`http://localhost:8080/api/pacientes/buscarCPF/${cpf}`)
    .then(res => {
      if (!res.ok) throw new Error("Paciente não encontrado.");
      return res.json();
    })
    .then(data => {
      document.querySelector('[name="paciNome"]').value = data.paciNome;
      document.querySelector('[name="paciConvenio"]').value = data.paciConvenio;
      alert("✅ Paciente encontrado!");
    })
    .catch(() => {
      alert("⚠️ Paciente não cadastrado.");
    });
}

const form = document.getElementById("consultaForm");
const tabela = document.querySelector("#tabelaConsultas tbody");

form.addEventListener("submit", function (e) {
  e.preventDefault();
  const dados = Object.fromEntries(new FormData(form).entries());

  fetch("http://localhost:8080/api/consulta2/efetuar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  })
  .then(res => res.json())
  .then(res => {
    const msg = document.getElementById("mensagem");
    if (res.success) {
      msg.textContent = "✅ Consulta registrada com sucesso!";
      msg.style.color = "green";
      form.reset();
      carregarConsultas();
    } else {
      msg.textContent = "❌ Erro: " + (res.error || "Verifique os dados.");
      msg.style.color = "red";
    }
  })
  .catch(() => {
    document.getElementById("mensagem").textContent = "❌ Erro na conexão com o servidor";
  });
});

function carregarConsultas() {
  fetch("http://localhost:8080/api/consulta2/listar")
    .then(res => res.json())
    .then(lista => {
      tabela.innerHTML = "";
      lista.forEach((c) => {
        const linha = document.createElement("tr");
        linha.innerHTML = `
          <td>${c.medNome}</td>
          <td>${c.medEspecialidade}</td>
          <td>${c.paciNome}</td>
          <td>${c.paciCPF}</td>
          <td>${c.paciConvenio}</td>
          <td>${c.conData}</td>
          <td>${c.horarioConsulta}</td>
          <td>${c.conTipo}</td>
          <td><button class="btn btn-sm btn-danger" onclick="excluirConsulta('${c.paciCPF}', '${c.conData}')">Excluir</button></td>`;
        tabela.appendChild(linha);
      });
    });
}

function excluirConsulta(cpf, data) {
  if (!confirm("Deseja excluir esta consulta?")) return;

  fetch(`http://localhost:8080/api/consulta2/excluir?cpf=${cpf}&data=${data}`, {
    method: "DELETE"
  })
  .then(res => res.json())
  .then(result => {
    const msg = document.getElementById("mensagem");
    if (result.success) {
      msg.textContent = "Consulta excluída com sucesso.";
      msg.style.color = "green";
      carregarConsultas();
    } else {
      msg.textContent = "Erro ao excluir consulta: " + (result.error || "");
      msg.style.color = "red";
    }
  })
  .catch(err => {
    document.getElementById("mensagem").textContent = "Erro ao excluir consulta.";
    console.error(err);
  });
}

window.onload = carregarConsultas;
</script>
</body>
</html>
